<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise Polyfill | askura</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="askura's weblog">
    <link rel="preload" href="/weblog/assets/css/0.styles.bd84e9de.css" as="style"><link rel="preload" href="/weblog/assets/js/app.73afb69f.js" as="script"><link rel="preload" href="/weblog/assets/js/2.b1d48028.js" as="script"><link rel="preload" href="/weblog/assets/js/25.e84d37ad.js" as="script"><link rel="prefetch" href="/weblog/assets/js/10.5e5257d2.js"><link rel="prefetch" href="/weblog/assets/js/11.ac268403.js"><link rel="prefetch" href="/weblog/assets/js/12.1aa44b2f.js"><link rel="prefetch" href="/weblog/assets/js/13.d254d810.js"><link rel="prefetch" href="/weblog/assets/js/14.99e6dc6d.js"><link rel="prefetch" href="/weblog/assets/js/15.b4307193.js"><link rel="prefetch" href="/weblog/assets/js/16.889db329.js"><link rel="prefetch" href="/weblog/assets/js/17.f907b394.js"><link rel="prefetch" href="/weblog/assets/js/18.eea8f088.js"><link rel="prefetch" href="/weblog/assets/js/19.84c994ab.js"><link rel="prefetch" href="/weblog/assets/js/20.91a0790a.js"><link rel="prefetch" href="/weblog/assets/js/21.f225089f.js"><link rel="prefetch" href="/weblog/assets/js/22.4271b9d7.js"><link rel="prefetch" href="/weblog/assets/js/23.29f5f4b4.js"><link rel="prefetch" href="/weblog/assets/js/24.12b1d527.js"><link rel="prefetch" href="/weblog/assets/js/26.b50519d9.js"><link rel="prefetch" href="/weblog/assets/js/27.15235234.js"><link rel="prefetch" href="/weblog/assets/js/28.8a9df4eb.js"><link rel="prefetch" href="/weblog/assets/js/29.9b595a2b.js"><link rel="prefetch" href="/weblog/assets/js/3.94d94b8f.js"><link rel="prefetch" href="/weblog/assets/js/30.cf77db1b.js"><link rel="prefetch" href="/weblog/assets/js/31.27e718fb.js"><link rel="prefetch" href="/weblog/assets/js/32.a51ac16d.js"><link rel="prefetch" href="/weblog/assets/js/33.e2fb7862.js"><link rel="prefetch" href="/weblog/assets/js/34.4f32cadf.js"><link rel="prefetch" href="/weblog/assets/js/4.a24ff65c.js"><link rel="prefetch" href="/weblog/assets/js/5.a6ef23be.js"><link rel="prefetch" href="/weblog/assets/js/6.c64d5164.js"><link rel="prefetch" href="/weblog/assets/js/7.05e16fa0.js"><link rel="prefetch" href="/weblog/assets/js/8.f29158ab.js"><link rel="prefetch" href="/weblog/assets/js/9.7ebc8f6b.js">
    <link rel="stylesheet" href="/weblog/assets/css/0.styles.bd84e9de.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/weblog/" class="home-link router-link-active"><!----> <span class="site-name">askura</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç½‘ç»œ" class="dropdown-title"><span class="title">ç½‘ç»œ</span> <span class="arrow down"></span></button> <button type="button" aria-label="ç½‘ç»œ" class="mobile-dropdown-title"><span class="title">ç½‘ç»œ</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          HTTP
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/net/http/cookie.html" class="nav-link">
  COOKIE
</a></li></ul></li><li class="dropdown-item"><h4>
          webå®‰å…¨
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/safety/web/csrf.html" class="nav-link">
  CSRF
</a></li><li class="dropdown-subitem"><a href="/weblog/safety/web/xss.html" class="nav-link">
  XSS
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GIT" class="dropdown-title"><span class="title">GIT</span> <span class="arrow down"></span></button> <button type="button" aria-label="GIT" class="mobile-dropdown-title"><span class="title">GIT</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          è¿œç¨‹ä»“åº“
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/git/remotes/clone.html" class="nav-link">
  clone
</a></li><li class="dropdown-subitem"><a href="/weblog/git/remotes/fetch.html" class="nav-link">
  fetch
</a></li><li class="dropdown-subitem"><a href="/weblog/git/remotes/pull.html" class="nav-link">
  pull
</a></li><li class="dropdown-subitem"><a href="/weblog/git/remotes/push.html" class="nav-link">
  push
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/weblog/git/branch.html" class="nav-link">
  branch
</a></li><li class="dropdown-item"><!----> <a href="/weblog/git/checkout.html" class="nav-link">
  checkout
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CSS" class="dropdown-title"><span class="title">CSS</span> <span class="arrow down"></span></button> <button type="button" aria-label="CSS" class="mobile-dropdown-title"><span class="title">CSS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Layout
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/css/layout/holy_grail.html" class="nav-link">
  åœ£æ¯å¸ƒå±€æ­ç§˜
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/weblog/css/contain_block.html" class="nav-link">
  åŒ…å«å—(positionå®šä½)
</a></li><li class="dropdown-item"><!----> <a href="/weblog/css/stacking_context.html" class="nav-link">
  Stacking Context
</a></li><li class="dropdown-item"><!----> <a href="/weblog/css/box_model.html" class="nav-link">
  Box Model
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="VIM" class="dropdown-title"><span class="title">VIM</span> <span class="arrow down"></span></button> <button type="button" aria-label="VIM" class="mobile-dropdown-title"><span class="title">VIM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          æ’ä»¶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/vim/plugins/airline.html" class="nav-link">
  airline
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="TMUX" class="dropdown-title"><span class="title">TMUX</span> <span class="arrow down"></span></button> <button type="button" aria-label="TMUX" class="mobile-dropdown-title"><span class="title">TMUX</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/tmux/theme.html" class="nav-link">
  theme
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="REDUX" class="dropdown-title"><span class="title">REDUX</span> <span class="arrow down"></span></button> <button type="button" aria-label="REDUX" class="mobile-dropdown-title"><span class="title">REDUX</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/redux/struct.html" class="nav-link">
  æˆ‘ç†è§£çš„redux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Browser" class="dropdown-title"><span class="title">Browser</span> <span class="arrow down"></span></button> <button type="button" aria-label="Browser" class="mobile-dropdown-title"><span class="title">Browser</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Net
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/browser/net/cross_domain.html" class="nav-link">
  Cross Domain
</a></li><li class="dropdown-subitem"><a href="/weblog/browser/net/jsonp.html" class="nav-link">
  JSONP
</a></li><li class="dropdown-subitem"><a href="/weblog/browser/net/iframe_cross.html" class="nav-link">
  IFrame Cross
</a></li></ul></li><li class="dropdown-item"><h4>
          Render
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/browser/render/parse_document.html" class="nav-link">
  Parse Document
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/weblog/browser/processing_model.html" class="nav-link">
  Processing Model
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JavaScript" class="dropdown-title"><span class="title">JavaScript</span> <span class="arrow down"></span></button> <button type="button" aria-label="JavaScript" class="mobile-dropdown-title"><span class="title">JavaScript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          ES6
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/javascript/ES6/Promise/api.html" class="nav-link">
  Promise API
</a></li><li class="dropdown-subitem"><a href="/weblog/javascript/ES6/Promise/polyfill.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Promise Polyfill
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/weblog/javascript/regExp.html" class="nav-link">
  RegExp
</a></li><li class="dropdown-item"><!----> <a href="/weblog/javascript/function.html" class="nav-link">
  å‡½æ•°
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å‰ç«¯å·¥ç¨‹åŒ–" class="dropdown-title"><span class="title">å‰ç«¯å·¥ç¨‹åŒ–</span> <span class="arrow down"></span></button> <button type="button" aria-label="å‰ç«¯å·¥ç¨‹åŒ–" class="mobile-dropdown-title"><span class="title">å‰ç«¯å·¥ç¨‹åŒ–</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/engineering/tree_shaking.html" class="nav-link">
  Tree Shaking
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="è®¾è®¡æ¨¡å¼" class="dropdown-title"><span class="title">è®¾è®¡æ¨¡å¼</span> <span class="arrow down"></span></button> <button type="button" aria-label="è®¾è®¡æ¨¡å¼" class="mobile-dropdown-title"><span class="title">è®¾è®¡æ¨¡å¼</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          OOP
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/design_pattern/oop/decorator.html" class="nav-link">
  Decorator Pattern
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ä¸€äº›æœ‰æ„æ€çš„ä¸œè¥¿" class="dropdown-title"><span class="title">ä¸€äº›æœ‰æ„æ€çš„ä¸œè¥¿</span> <span class="arrow down"></span></button> <button type="button" aria-label="ä¸€äº›æœ‰æ„æ€çš„ä¸œè¥¿" class="mobile-dropdown-title"><span class="title">ä¸€äº›æœ‰æ„æ€çš„ä¸œè¥¿</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/interesting/git_credential.html" class="nav-link">
  è®¨åŒçš„credential.helper=osxkeychain
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="vue" class="dropdown-title"><span class="title">vue</span> <span class="arrow down"></span></button> <button type="button" aria-label="vue" class="mobile-dropdown-title"><span class="title">vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/vue/preface.html" class="nav-link">
  å¯¹Vueçš„è®¤çŸ¥
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Threejs" class="dropdown-title"><span class="title">Threejs</span> <span class="arrow down"></span></button> <button type="button" aria-label="Threejs" class="mobile-dropdown-title"><span class="title">Threejs</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/threejs/struct.html" class="nav-link">
  åˆè¯†webgl
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç½‘ç»œ" class="dropdown-title"><span class="title">ç½‘ç»œ</span> <span class="arrow down"></span></button> <button type="button" aria-label="ç½‘ç»œ" class="mobile-dropdown-title"><span class="title">ç½‘ç»œ</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          HTTP
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/net/http/cookie.html" class="nav-link">
  COOKIE
</a></li></ul></li><li class="dropdown-item"><h4>
          webå®‰å…¨
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/safety/web/csrf.html" class="nav-link">
  CSRF
</a></li><li class="dropdown-subitem"><a href="/weblog/safety/web/xss.html" class="nav-link">
  XSS
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GIT" class="dropdown-title"><span class="title">GIT</span> <span class="arrow down"></span></button> <button type="button" aria-label="GIT" class="mobile-dropdown-title"><span class="title">GIT</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          è¿œç¨‹ä»“åº“
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/git/remotes/clone.html" class="nav-link">
  clone
</a></li><li class="dropdown-subitem"><a href="/weblog/git/remotes/fetch.html" class="nav-link">
  fetch
</a></li><li class="dropdown-subitem"><a href="/weblog/git/remotes/pull.html" class="nav-link">
  pull
</a></li><li class="dropdown-subitem"><a href="/weblog/git/remotes/push.html" class="nav-link">
  push
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/weblog/git/branch.html" class="nav-link">
  branch
</a></li><li class="dropdown-item"><!----> <a href="/weblog/git/checkout.html" class="nav-link">
  checkout
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CSS" class="dropdown-title"><span class="title">CSS</span> <span class="arrow down"></span></button> <button type="button" aria-label="CSS" class="mobile-dropdown-title"><span class="title">CSS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Layout
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/css/layout/holy_grail.html" class="nav-link">
  åœ£æ¯å¸ƒå±€æ­ç§˜
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/weblog/css/contain_block.html" class="nav-link">
  åŒ…å«å—(positionå®šä½)
</a></li><li class="dropdown-item"><!----> <a href="/weblog/css/stacking_context.html" class="nav-link">
  Stacking Context
</a></li><li class="dropdown-item"><!----> <a href="/weblog/css/box_model.html" class="nav-link">
  Box Model
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="VIM" class="dropdown-title"><span class="title">VIM</span> <span class="arrow down"></span></button> <button type="button" aria-label="VIM" class="mobile-dropdown-title"><span class="title">VIM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          æ’ä»¶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/vim/plugins/airline.html" class="nav-link">
  airline
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="TMUX" class="dropdown-title"><span class="title">TMUX</span> <span class="arrow down"></span></button> <button type="button" aria-label="TMUX" class="mobile-dropdown-title"><span class="title">TMUX</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/tmux/theme.html" class="nav-link">
  theme
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="REDUX" class="dropdown-title"><span class="title">REDUX</span> <span class="arrow down"></span></button> <button type="button" aria-label="REDUX" class="mobile-dropdown-title"><span class="title">REDUX</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/redux/struct.html" class="nav-link">
  æˆ‘ç†è§£çš„redux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Browser" class="dropdown-title"><span class="title">Browser</span> <span class="arrow down"></span></button> <button type="button" aria-label="Browser" class="mobile-dropdown-title"><span class="title">Browser</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Net
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/browser/net/cross_domain.html" class="nav-link">
  Cross Domain
</a></li><li class="dropdown-subitem"><a href="/weblog/browser/net/jsonp.html" class="nav-link">
  JSONP
</a></li><li class="dropdown-subitem"><a href="/weblog/browser/net/iframe_cross.html" class="nav-link">
  IFrame Cross
</a></li></ul></li><li class="dropdown-item"><h4>
          Render
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/browser/render/parse_document.html" class="nav-link">
  Parse Document
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/weblog/browser/processing_model.html" class="nav-link">
  Processing Model
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JavaScript" class="dropdown-title"><span class="title">JavaScript</span> <span class="arrow down"></span></button> <button type="button" aria-label="JavaScript" class="mobile-dropdown-title"><span class="title">JavaScript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          ES6
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/javascript/ES6/Promise/api.html" class="nav-link">
  Promise API
</a></li><li class="dropdown-subitem"><a href="/weblog/javascript/ES6/Promise/polyfill.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Promise Polyfill
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/weblog/javascript/regExp.html" class="nav-link">
  RegExp
</a></li><li class="dropdown-item"><!----> <a href="/weblog/javascript/function.html" class="nav-link">
  å‡½æ•°
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å‰ç«¯å·¥ç¨‹åŒ–" class="dropdown-title"><span class="title">å‰ç«¯å·¥ç¨‹åŒ–</span> <span class="arrow down"></span></button> <button type="button" aria-label="å‰ç«¯å·¥ç¨‹åŒ–" class="mobile-dropdown-title"><span class="title">å‰ç«¯å·¥ç¨‹åŒ–</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/engineering/tree_shaking.html" class="nav-link">
  Tree Shaking
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="è®¾è®¡æ¨¡å¼" class="dropdown-title"><span class="title">è®¾è®¡æ¨¡å¼</span> <span class="arrow down"></span></button> <button type="button" aria-label="è®¾è®¡æ¨¡å¼" class="mobile-dropdown-title"><span class="title">è®¾è®¡æ¨¡å¼</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          OOP
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/weblog/design_pattern/oop/decorator.html" class="nav-link">
  Decorator Pattern
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ä¸€äº›æœ‰æ„æ€çš„ä¸œè¥¿" class="dropdown-title"><span class="title">ä¸€äº›æœ‰æ„æ€çš„ä¸œè¥¿</span> <span class="arrow down"></span></button> <button type="button" aria-label="ä¸€äº›æœ‰æ„æ€çš„ä¸œè¥¿" class="mobile-dropdown-title"><span class="title">ä¸€äº›æœ‰æ„æ€çš„ä¸œè¥¿</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/interesting/git_credential.html" class="nav-link">
  è®¨åŒçš„credential.helper=osxkeychain
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="vue" class="dropdown-title"><span class="title">vue</span> <span class="arrow down"></span></button> <button type="button" aria-label="vue" class="mobile-dropdown-title"><span class="title">vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/vue/preface.html" class="nav-link">
  å¯¹Vueçš„è®¤çŸ¥
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Threejs" class="dropdown-title"><span class="title">Threejs</span> <span class="arrow down"></span></button> <button type="button" aria-label="Threejs" class="mobile-dropdown-title"><span class="title">Threejs</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/threejs/struct.html" class="nav-link">
  åˆè¯†webgl
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Promise Polyfill</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/weblog/javascript/ES6/Promise/polyfill.html#å®è·µ" class="sidebar-link">å®è·µ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/weblog/javascript/ES6/Promise/polyfill.html#å¼€å‘-promise-polyfill-çš„ä¸€äº›æå‰å‡†å¤‡" class="sidebar-link">å¼€å‘ Promise Polyfill çš„ä¸€äº›æå‰å‡†å¤‡</a></li><li class="sidebar-sub-header"><a href="/weblog/javascript/ES6/Promise/polyfill.html#åšå®ä¾‹åŒ–çš„å‡†å¤‡" class="sidebar-link">åšå®ä¾‹åŒ–çš„å‡†å¤‡</a></li><li class="sidebar-sub-header"><a href="/weblog/javascript/ES6/Promise/polyfill.html#å®ä¾‹åŒ–-promise" class="sidebar-link">å®ä¾‹åŒ– Promise</a></li><li class="sidebar-sub-header"><a href="/weblog/javascript/ES6/Promise/polyfill.html#å¤„ç†-promise-çš„æ ¸å¿ƒé€»è¾‘-ä¹Ÿå°±æ˜¯-a-ä¸­æåˆ°çš„-resolve-promise-x-çš„è¿‡ç¨‹" class="sidebar-link">å¤„ç† Promise çš„æ ¸å¿ƒé€»è¾‘, ä¹Ÿå°±æ˜¯ A+ä¸­æåˆ°çš„[Resolve]çš„è¿‡ç¨‹</a></li><li class="sidebar-sub-header"><a href="/weblog/javascript/ES6/Promise/polyfill.html#å®ç°rejectpromiseçš„é€»è¾‘" class="sidebar-link">å®ç°rejectPromiseçš„é€»è¾‘</a></li><li class="sidebar-sub-header"><a href="/weblog/javascript/ES6/Promise/polyfill.html#å¤„ç†-then-æ–¹æ³•çš„é€»è¾‘" class="sidebar-link">å¤„ç† then æ–¹æ³•çš„é€»è¾‘</a></li><li class="sidebar-sub-header"><a href="/weblog/javascript/ES6/Promise/polyfill.html#å¤„ç†-callback-é˜Ÿåˆ—" class="sidebar-link">å¤„ç† callback é˜Ÿåˆ—</a></li><li class="sidebar-sub-header"><a href="/weblog/javascript/ES6/Promise/polyfill.html#å‰©ä¸‹å°±æ˜¯å®Œå–„é‚£äº›å·¥å…·æ–¹æ³•" class="sidebar-link">å‰©ä¸‹å°±æ˜¯å®Œå–„é‚£äº›å·¥å…·æ–¹æ³•</a></li></ul></li><li><a href="/weblog/javascript/ES6/Promise/polyfill.html#å®Œæ•´ä»£ç " class="sidebar-link">å®Œæ•´ä»£ç </a><ul class="sidebar-sub-headers"></ul></li><li><a href="/weblog/javascript/ES6/Promise/polyfill.html#test" class="sidebar-link">Test</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="promise-polyfill"><a href="#promise-polyfill" class="header-anchor">#</a> Promise Polyfill</h1> <p><a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">A+ åŸæ–‡<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="http://malcolmyu.github.io/malnote/2015/06/12/Promises-A-Plus/" target="_blank" rel="noopener noreferrer">æ˜æ˜Šå¤§ä½¬çš„ A+è¯‘æ–‡<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="å®è·µ"><a href="#å®è·µ" class="header-anchor">#</a> å®è·µ</h2> <div class="custom-block warning"><p class="custom-block-title">- æ³¨æ„</p> <p>é˜…è¯»åˆ†è§£çš„ä»£ç éœ€è¦å°å¿ƒ, å› ä¸ºæˆ‘å°†å…¶å¤åˆæˆå®Œæ•´çš„ä»£ç å, å‘ç°æœ‰ä¸€äº›æ‹¼å†™ä¸Šçš„é”™è¯¯</p> <p>å·²ç»å¯¹æ¯”æ—¥å¿—ä¿®å¤äº†...</p> <p>ä½†æ˜¯å¯èƒ½è¿˜æœ‰æˆ‘æœªå‘ç°çš„</p> <p>å®Œæ•´çš„ä»£ç æ˜¯å¯ä»¥é€šè¿‡æµ‹è¯•ç”¨ä¾‹çš„ æ²¡é—®é¢˜</p></div> <h3 id="å¼€å‘-promise-polyfill-çš„ä¸€äº›æå‰å‡†å¤‡"><a href="#å¼€å‘-promise-polyfill-çš„ä¸€äº›æå‰å‡†å¤‡" class="header-anchor">#</a> å¼€å‘ Promise Polyfill çš„ä¸€äº›æå‰å‡†å¤‡</h3> <p>é¦–å…ˆæˆ‘ä»¬è¦å°é—­ä½œç”¨åŸŸä»¥åŠå®šä¹‰å¥½ä¸€äº›å¸¸é‡...</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> PromisePolyfill <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* promise çš„ 3ç§çŠ¶æ€ */</span>
  <span class="token keyword">const</span> <span class="token constant">PENDDING</span> <span class="token operator">=</span> <span class="token string">'pendding'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>

  <span class="token comment">/* promiseå®ä¾‹ä¸Šæš´éœ²å‡ºçš„å±æ€§ */</span>
  <span class="token keyword">const</span> <span class="token constant">PROMISEVALUE</span> <span class="token operator">=</span> <span class="token string">'promise_value'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">PROMISESTATUS</span> <span class="token operator">=</span> <span class="token string">'promise_status'</span><span class="token punctuation">;</span>

  <span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">return</span> MyPromise<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="åšå®ä¾‹åŒ–çš„å‡†å¤‡"><a href="#åšå®ä¾‹åŒ–çš„å‡†å¤‡" class="header-anchor">#</a> åšå®ä¾‹åŒ–çš„å‡†å¤‡</h3> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROMISEVALUE</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">PENDDING</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="å®ä¾‹åŒ–-promise"><a href="#å®ä¾‹åŒ–-promise" class="header-anchor">#</a> å®ä¾‹åŒ– Promise</h3> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>æˆ‘ä»¬çŸ¥é“<code>Promise</code>æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°, æ‰€ä»¥<code>constructor</code>éœ€è¦æ¥å—ä¸€ä¸ªå‡½æ•°<code>func</code>, åŒæ—¶è¿™ä¸ªå‡½æ•°ä¼šè¢«ä¼ å…¥<code>resolve</code>å’Œ<code>reject</code>2 ä¸ªå‚æ•°(ç±»å‹ä¸º<code>function</code>)</p> <p>å¹¶ä¸”å› ä¸º<code>Promise</code>çš„çŠ¶æ€ä¸€ä½†é<code>PENDDING</code>åˆ™ä¸å¯å˜, æ‰€ä»¥<code>resolve</code>å’Œ<code>reject</code>åº”è¯¥æ˜¯äº’æ–¥çš„</p> <p>åŒæ—¶<code>Promise</code>ä¼šæ•è·<code>func</code>ä¸­æŠ›å‡ºçš„å¼‚å¸¸, æ‰€ä»¥æœ‰</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* @desc ä¸€ä¸ªäº’æ–¥å‡½æ•°, ç”¨æ¥å¤„ç†resolveå’Œrejectäº’æ–¥ */</span>
<span class="token keyword">function</span> <span class="token function">applyOnce</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>funcs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> funcs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">func</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>argvs</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token function">func</span><span class="token punctuation">(</span><span class="token operator">...</span>argvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">applyOnce</span><span class="token punctuation">(</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">func</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>è¿™æ ·<code>resolve</code>å’Œ<code>reject</code>äº’æ–¥äº†, func çš„å¼‚å¸¸ä¹Ÿè¢«æ•è·äº†, å®åŠ›åŒ–çš„è¿‡ç¨‹å°±åŸºæœ¬å®Œæˆ</p> <h3 id="å¤„ç†-promise-çš„æ ¸å¿ƒé€»è¾‘-ä¹Ÿå°±æ˜¯-a-ä¸­æåˆ°çš„-resolve-promise-x-çš„è¿‡ç¨‹"><a href="#å¤„ç†-promise-çš„æ ¸å¿ƒé€»è¾‘-ä¹Ÿå°±æ˜¯-a-ä¸­æåˆ°çš„-resolve-promise-x-çš„è¿‡ç¨‹" class="header-anchor">#</a> å¤„ç† Promise çš„æ ¸å¿ƒé€»è¾‘, ä¹Ÿå°±æ˜¯ A+ä¸­æåˆ°çš„[[Resolve]](promise, x)çš„è¿‡ç¨‹</h3> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* è¿™é‡Œçš„contextæ˜¯promiseå®ä¾‹ */</span>

  <span class="token comment">// å‰é¢æåˆ°è¿‡promiseçš„çŠ¶æ€ä¸€æ—¦éPENDDINGå…¶çŠ¶æ€å°±ä¸ä¼šæ”¹å˜, æ‰€ä»¥</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token constant">PENDDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment">// æ¥ä¸‹æ¥æŒ‰ç…§A+è§„èŒƒçš„æ­¥éª¤å¼€å§‹å¤„ç†contextå’Œxçš„å€¼</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> conetxt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected for promise #&lt;PromisePolyfill&gt;'</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è¿™é‡Œå°±æ˜¯é€ä¼ xçš„çŠ¶æ€å’Œå€¼ç»™å½“å‰çš„context</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token comment">// å½“å‰contextç­‰å¾…xçš„çŠ¶æ€, å¦‚æœx fulfilledåˆ™ç”¨x.value é‡æ–°è¿›è¡Œä¸€æ¬¡å½“å‰é€»è¾‘, å¦‚æœx rejected, åˆ™ç”¨å…¶reason, æ‰§è¡Œæ‹’ç»promiseçš„é€»è¾‘</span>
      <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token function">rejectPromise</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è¿™é‡Œæ˜¯A+ ä¸­å¦‚æœxæ˜¯å¯¹è±¡æˆ–å‡½æ•°, å¦‚æœæœ‰thenæ–¹æ³•, åˆ™å°†è¿™ä¸ªthenableè§†ä¸ºå¦ç±»çš„å®ä¾‹åŒ–Promiseæ—¶ä¼ å…¥çš„å‡½æ•°</span>
  <span class="token comment">// ä»¥xä½œä¸ºthenæ‰§è¡Œçš„ä¸Šä¸‹æ–‡, ä¼ å…¥resolveå’Œreject, ä»¥resolveå’Œrejectåœ¨æ‰§è¡Œæ—¶ä¼ å…¥çš„å‚æ•°y, ä½œä¸ºå½“å‰çš„å®ä¾‹çš„ç»“æœæˆ–æ‹’å› </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isThenable</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> then <span class="token punctuation">}</span> <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token comment">// è¿™é‡Œæ˜¯ä¸ºäº†é˜²æ­¢x.thenæœ‰å‰¯ä½œç”¨, å®šä¹‰äº†getter.</span>

    <span class="token comment">// æ‰€ä»¥ä¸Šé¢åªèƒ½ä½¿ç”¨isThenableæ¥åˆ¤æ–­xæ˜¯ä¸æ˜¯æœ‰thenæ–¹æ³•æˆ–thenå±æ€§çš„å¼•ç”¨å€¼</span>

    <span class="token comment">// è¿™é‡Œè¿˜è¦åŠ ä¸Šthenæ˜¯å‡½æ•°çš„åˆ¤æ–­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>then<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">applyOnce</span><span class="token punctuation">(</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// è¿™å°±ç»“æŸäº†thenableçš„åˆ¤æ–­</span>

      <span class="token comment">/*
       * ä½ ä¼šå‘ç°å½“å‰çš„contextçš„çŠ¶æ€å¹¶æ²¡æœ‰æµè½¬
       * è¿™æ˜¯å› ä¸ºåªæœ‰ç­‰åˆ°å®é™…æ‰§è¡Œresolveçš„æ—¶å€™æ‰è¦æµè½¬çŠ¶æ€
       * è€ŒçŠ¶æ€çš„æµè½¬å’ŒresolvePromiseæ¯æ¯ç›¸å…³
       * ä¸Šé¢çš„resolveå‡½æ•°è¦å’ŒresolvePromiseæœ‰å…³ç³»
       * å³:
       * resolve = partial(resolvePromise, context);
       * ç”¨ä¸€ä¸ªåå‡½æ•°å°†å½“å‰å®ä¾‹é¢„å…ˆä¼ å…¥åˆ°resolvePromiseä¸­å¾—åˆ°æ–°çš„å‡½æ•°
       */</span>

      <span class="token comment">// æ‰€ä»¥æœ‰</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">applyOnce</span><span class="token punctuation">(</span>
        <span class="token function">partial</span><span class="token punctuation">(</span>resolvePromise<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">partial</span><span class="token punctuation">(</span>rejectPromise<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// æˆ‘ä¹‹å‰çš„å®ç°ä¸Šæœ‰æ³¨é‡Šè¿™é‡Œéœ€è¦å¼‚æ­¥æ‰§è¡Œçš„...ä½†æ˜¯æˆ‘ç°åœ¨æ‰¾ä¸åˆ°åŸå› äº†...............ğŸ˜¢..</span>
      <span class="token comment">// ä¸éœ€è¦å¼‚æ­¥.. æˆ‘å°±è¯´å˜›</span>
      <span class="token comment">// è¿™é‡Œçš„å¼‚å¸¸éœ€è¦å•ç‹¬å¤„ç†, è¿™æ˜¯å› ä¸ºresolveå’Œrejectéœ€è¦äº’æ–¥</span>
      <span class="token comment">/*
       * @example
       * new Promise((resolve, reject) =&gt; {
       *   resolve({
       *     then(resolve, reject) {
       *       resolve(new Promise(resolve =&gt; setTimeout(resolve.bind(null, 1)))) // è¿™é‡Œæ˜¯å¼‚æ­¥ç­‰å¾…promiseå®ä¾‹çš„çŠ¶æ€
       *       throw 1;
       *     }
       *   });
       * })
       */</span>
       <span class="token comment">// ä»…ä»…ä¾é resovlePromiseå’ŒrejectPromiseçš„çŠ¶æ€é”æ˜¯ä¸èƒ½fixè¿™ç§æƒ…å†µçš„</span>
       <span class="token comment">// æœ¬æ¥åº”è¯¥æ˜¯fulfilledçŠ¶æ€çš„promiseè¢«è§£å†³æˆrejectedçŠ¶æ€</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// å› ä¸ºè¿™é‡Œå•ç‹¬å¤„ç†å¼‚å¸¸, æ‰€ä»¥å°±å¯ä»¥returnæ‰</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è¿˜æ²¡å®Œ, è¿™ä¸­é—´çš„å¼‚å¸¸éœ€è¦è¢«æ•è· æ‰€ä»¥éœ€è¦</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... ä¸Šé¢çš„ä¸€æ‹–ä»£ç </span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">rejectPromise</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ç‰¹æ®Šå€¼çš„å¤„ç†éƒ½å®Œæˆäº†å‰©ä¸‹éœ€è¦æ›´æ–°çŠ¶æ€å’Œå€¼ï¼Œä»¥åŠæ‰§è¡Œcallback</span>
  context<span class="token punctuation">[</span><span class="token constant">PROMISEVALUE</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
  context<span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>

  <span class="token function">applyCallbacks</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>fulfilledCallbacks<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// å¯¹äºcontext.fulfilledCallbacksæ‰§è¡Œæ—¶ä¹Ÿå¯èƒ½ä¼šæœ‰å¼‚å¸¸, ä½†æ˜¯å› ä¸ºå…¶å¼‚æ­¥æ‰§è¡Œè¿™è¾¹ä¸å¥½å¤„ç†</span>
  <span class="token comment">// åªèƒ½æ˜¯è¿™é‡Œé¢çš„callbackåœ¨thenæ–¹æ³•å†…è¢«pushå‰å·²ç»è¢«å°è£…å¥½try...catchäº†</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><h3 id="å®ç°rejectpromiseçš„é€»è¾‘"><a href="#å®ç°rejectpromiseçš„é€»è¾‘" class="header-anchor">#</a> å®ç°<code>rejectPromise</code>çš„é€»è¾‘</h3> <p>æœ‰äº†<code>resolvePromise(context, x)</code>çš„é€»è¾‘, å®ç°<code>rejectPromise(context, reason)</code>çš„é€»è¾‘å°±å¾ˆç®€å•äº†</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">rejectPromise</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token constant">PENDDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  context<span class="token punctuation">[</span><span class="token constant">PROMISEVALUE</span><span class="token punctuation">]</span> <span class="token operator">=</span> reason<span class="token punctuation">;</span>
  context<span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>

  <span class="token function">applyCallbacks</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>rejectedCallbacks<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="å¤„ç†-then-æ–¹æ³•çš„é€»è¾‘"><a href="#å¤„ç†-then-æ–¹æ³•çš„é€»è¾‘" class="header-anchor">#</a> å¤„ç† then æ–¹æ³•çš„é€»è¾‘</h3> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™é‡Œæ ¹æ®thenableçš„å¤„ç†æµç¨‹å¯ä»¥è¢«æ·»åŠ ä¸Šäº†</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">applyOnce</span><span class="token punctuation">(</span>
      <span class="token function">partial</span><span class="token punctuation">(</span>resolvePromise<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">partial</span><span class="token punctuation">(</span>rejectPromise<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">func</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">fulfilledCallback<span class="token punctuation">,</span> rejectedCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å› ä¸ºå¦‚æœfulfilledCallbackä¸æ˜¯å‡½æ•°éœ€è¦å¿½ç•¥å³å°†è¿”å›å€¼ä¼ ç»™next fulfilledCallback</span>

    <span class="token keyword">let</span> onFulfilled <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>fulfilledCallback<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token function-variable function">fulfilledCallback</span>
      <span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">;</span>

    <span class="token comment">// rejectedCallbackå¦‚æœä¸æ˜¯å‡½æ•°éœ€è¦å¿½ç•¥ï¼Œä½†æ˜¯å®ƒä¸èƒ½é€ä¼ å€¼ï¼Œå› ä¸ºé€ä¼ å€¼çš„è¯ï¼Œpromiseçš„çŠ¶æ€å°±å˜äº†</span>
    <span class="token comment">// å…¶éœ€è¦ç»§ç»­æŠ›å‡ºreason</span>

    <span class="token keyword">let</span> onRejected <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>rejectedCallback<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token function-variable function">rejectedCallback</span>
      <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token keyword">throw</span> reason<span class="token punctuation">;</span>

    <span class="token comment">// ç”±äºå¯ä»¥é“¾å¼è°ƒç”¨</span>
    <span class="token keyword">let</span> resolve<span class="token punctuation">,</span>
        reject
    <span class="token keyword">const</span> retPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rs<span class="token punctuation">,</span> re</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      resolve <span class="token operator">=</span> rs<span class="token punctuation">;</span>
      reject <span class="token operator">=</span> re<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è¿™ä¸ªretPromiseçš„çŠ¶æ€ç”±resolveå’Œrejectå†³å®š, æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å…¶å’Œæ¯æ‰å‡½æ•°å°è£…</span>

    onRejected <span class="token operator">=</span> <span class="token function">callbackFactory</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    onFulfilled <span class="token operator">=</span> <span class="token function">callbackFactory</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> retPromise<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">callbackFactory</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// å› ä¸ºéœ€è¦å°†è¿”å›å€¼ä¼ ç»™next callback</span>
      <span class="token comment">// æ‰€ä»¥</span>
      <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="å¤„ç†-callback-é˜Ÿåˆ—"><a href="#å¤„ç†-callback-é˜Ÿåˆ—" class="header-anchor">#</a> å¤„ç† callback é˜Ÿåˆ—</h3> <p>æˆ‘ä»¬çŸ¥é“<code>Promise</code>å¯ä»¥æœ‰å¾ˆå¤šä¸ªå›è°ƒå‡½æ•°ç„¶åç­‰å¾…çŠ¶æ€å˜æ›´åä¸€èµ·æ‰§è¡Œ</p> <p>å³:</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">ret</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">ret</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">ret</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ­¤æ—¶çŠ¶æ€å˜æ›´</span>
<span class="token comment">// 1</span>
<span class="token comment">// 2</span>
<span class="token comment">// 3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>åŒæ—¶å¦‚æœå®ä¾‹çš„çŠ¶æ€å·²ç»å˜åŒ–é‚£ä¹ˆåœ¨è¿™ä¹‹åæ·»åŠ çš„<code>then callback</code>ä¼šç«‹å³æ‰§è¡Œ</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸ªé˜Ÿåˆ—è¿›è¡Œç‰¹æ®Šå¤„ç†, çŠ¶æ€æœªæ”¹å˜åˆ™æ·»åŠ , çŠ¶æ€æ”¹å˜åˆ™ç«‹å³æ‰§è¡Œ</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">CallbackQueue</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> status</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// override</span>
  <span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">func</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// override</span>
  <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™é‡Œåˆ¤æ–­çŠ¶æ€</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">applyAsync</span><span class="token punctuation">(</span><span class="token function">partial</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">[</span><span class="token constant">PROMISEVALUE</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FulfilledCallbackQueue</span> <span class="token keyword">extends</span> <span class="token class-name">CallbackQueue</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">RejectedCallbackQueue</span> <span class="token keyword">extends</span> <span class="token class-name">CallbackQueue</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedCallbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RejectedCallbacks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fulfilledCallbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FulfilledCallbackQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="å‰©ä¸‹å°±æ˜¯å®Œå–„é‚£äº›å·¥å…·æ–¹æ³•"><a href="#å‰©ä¸‹å°±æ˜¯å®Œå–„é‚£äº›å·¥å…·æ–¹æ³•" class="header-anchor">#</a> å‰©ä¸‹å°±æ˜¯å®Œå–„é‚£äº›å·¥å…·æ–¹æ³•</h3> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* @desc æ˜¯ä¸æ˜¯å‡½æ•° */</span>
<span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> func <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* @desc æ˜¯ä¸æ˜¯Promise */</span>
<span class="token keyword">function</span> <span class="token function">isPromise</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    x <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span>
    <span class="token operator">||</span> x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* @desc æ˜¯ä¸æ˜¯thenable */</span>
<span class="token keyword">function</span> <span class="token function">isThenable</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token string">'then'</span> <span class="token keyword">in</span> x <span class="token comment">// è¿™é‡Œè¦ä½¿ç”¨inè¿ç®—ç¬¦ ä¸ç”¨ä½¿ç”¨x.then</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* @desc åå‡½æ•° */</span>
<span class="token keyword">function</span> <span class="token function">partial</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> <span class="token operator">...</span>argvs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>remainArgvs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">func</span><span class="token punctuation">(</span><span class="token operator">...</span>argvs<span class="token punctuation">,</span> <span class="token operator">...</span>remainArgvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* @desc æ¨¡æ‹Ÿmicro task */</span>
<span class="token keyword">function</span> <span class="token function">applyAsync</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* @desc æ‰§è¡Œå›è°ƒå‡½æ•°é˜Ÿåˆ— */</span>
<span class="token keyword">function</span> <span class="token function">applyCallbacks</span><span class="token punctuation">(</span><span class="token parameter">callbacks<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  callbacks
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token function">partial</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token function">applyAsync</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h2 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="header-anchor">#</a> å®Œæ•´ä»£ç </h2> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* eslint-disable */</span>
<span class="token keyword">const</span> PromisePolyfill <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* promise çš„ 3ç§çŠ¶æ€ */</span>
  <span class="token keyword">const</span> <span class="token constant">PENDDING</span> <span class="token operator">=</span> <span class="token string">'pendding'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>

  <span class="token comment">/* promiseå®ä¾‹ä¸Šæš´éœ²å‡ºçš„å±æ€§ */</span>
  <span class="token keyword">const</span> <span class="token constant">PROMISEVALUE</span> <span class="token operator">=</span> <span class="token string">'promise_value'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">PROMISESTATUS</span> <span class="token operator">=</span> <span class="token string">'promise_status'</span><span class="token punctuation">;</span>

  <span class="token comment">/* @desc æ˜¯ä¸æ˜¯å‡½æ•° */</span>
  <span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> func <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* @desc æ˜¯ä¸æ˜¯Promise */</span>
  <span class="token keyword">function</span> <span class="token function">isPromise</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span> <span class="token operator">||</span> x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* @desc æ˜¯ä¸æ˜¯thenable */</span>
  <span class="token keyword">function</span> <span class="token function">isThenable</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">'then'</span> <span class="token keyword">in</span> x <span class="token comment">// è¿™é‡Œè¦ä½¿ç”¨inè¿ç®—ç¬¦ ä¸ç”¨ä½¿ç”¨x.then</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* @desc åå‡½æ•° */</span>
  <span class="token keyword">function</span> <span class="token function">partial</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> <span class="token operator">...</span>argvs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>remainArgvs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// eslint-disable-line</span>
      <span class="token function">func</span><span class="token punctuation">(</span><span class="token operator">...</span>argvs<span class="token punctuation">,</span> <span class="token operator">...</span>remainArgvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* @desc æ¨¡æ‹Ÿmicro task */</span>
  <span class="token keyword">function</span> <span class="token function">applyAsync</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* @desc æ‰§è¡Œå›è°ƒå‡½æ•°é˜Ÿåˆ— */</span>
  <span class="token keyword">function</span> <span class="token function">applyCallbacks</span><span class="token punctuation">(</span><span class="token parameter">callbacks<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    callbacks
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token function">partial</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// eslint-disable-line</span>
      <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">applyAsync</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// elsint-disable-line</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* @desc ä¸€ä¸ªäº’æ–¥å‡½æ•°, ç”¨æ¥å¤„ç†resolveå’Œrejectäº’æ–¥ */</span>
  <span class="token keyword">function</span> <span class="token function">applyOnce</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>funcs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> funcs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>argvs</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      <span class="token function">func</span><span class="token punctuation">(</span><span class="token operator">...</span>argvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* @desc å°è£…thenä¼ å…¥çš„å›è°ƒå‡½æ•° */</span>
  <span class="token keyword">function</span> <span class="token function">callbackFactory</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">class</span> <span class="token class-name">CallbackQueue</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> status</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// override</span>
    <span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">func</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// override</span>
    <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿™é‡Œåˆ¤æ–­çŠ¶æ€</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">applyAsync</span><span class="token punctuation">(</span><span class="token function">partial</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">[</span><span class="token constant">PROMISEVALUE</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">class</span> <span class="token class-name">FulfilledCallbackQueue</span> <span class="token keyword">extends</span> <span class="token class-name">CallbackQueue</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">class</span> <span class="token class-name">RejectedCallbackQueue</span> <span class="token keyword">extends</span> <span class="token class-name">CallbackQueue</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">rejectPromise</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token constant">PENDDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>

    context<span class="token punctuation">[</span><span class="token constant">PROMISEVALUE</span><span class="token punctuation">]</span> <span class="token operator">=</span> reason<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>
    context<span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>

    <span class="token function">applyCallbacks</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>rejectedCallbacks<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token constant">PENDDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected for promise #&lt;PromisePolyfill&gt;'</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">rejectPromise</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isThenable</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> then <span class="token punctuation">}</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>then<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">applyOnce</span><span class="token punctuation">(</span>
            <span class="token function">partial</span><span class="token punctuation">(</span>resolvePromise<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">partial</span><span class="token punctuation">(</span>rejectPromise<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">rejectPromise</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    context<span class="token punctuation">[</span><span class="token constant">PROMISEVALUE</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>
    context<span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span> <span class="token comment">// eslint-diable-line</span>

    <span class="token function">applyCallbacks</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>fulfilledCallbacks<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROMISEVALUE</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROMISESTATUS</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">PENDDING</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedCallbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RejectedCallbackQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fulfilledCallbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FulfilledCallbackQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">applyOnce</span><span class="token punctuation">(</span>
        <span class="token function">partial</span><span class="token punctuation">(</span>resolvePromise<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">partial</span><span class="token punctuation">(</span>rejectPromise<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">func</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">fulfilledCallback<span class="token punctuation">,</span> rejectedCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> onFulfilled <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>fulfilledCallback<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function-variable function">fulfilledCallback</span>
        <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">;</span>

      <span class="token keyword">let</span> onRejected <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>rejectedCallback<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function-variable function">rejectedCallback</span>
        <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> reason<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">let</span> resolve<span class="token punctuation">;</span>
      <span class="token keyword">let</span> reject<span class="token punctuation">;</span>
      <span class="token keyword">const</span> retPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rs<span class="token punctuation">,</span> re</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        resolve <span class="token operator">=</span> rs<span class="token punctuation">;</span>
        reject <span class="token operator">=</span> re<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      onRejected <span class="token operator">=</span> <span class="token function">callbackFactory</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      onFulfilled <span class="token operator">=</span> <span class="token function">callbackFactory</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> retPromise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> MyPromise<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br></div></div><h2 id="test"><a href="#test" class="header-anchor">#</a> Test</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> -D promises-aplus-tests
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>ç¼–å†™å¦‚ä¸‹å‰ç½®æ¨¡å—å¯¼å‡º</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// test.js</span>
<span class="token keyword">const</span> MyPromise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dfd <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  dfd<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dfd<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
    dfd<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> dfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

MyPromise<span class="token punctuation">.</span>deferred <span class="token operator">=</span> deferred<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>promises-aplus-test ./test.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/arkusa/askura/edit/master/docs/javascript/ES6/Promise/polyfill.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘æ­¤é¡µé¢</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/weblog/assets/js/app.73afb69f.js" defer></script><script src="/weblog/assets/js/2.b1d48028.js" defer></script><script src="/weblog/assets/js/25.e84d37ad.js" defer></script>
  </body>
</html>
