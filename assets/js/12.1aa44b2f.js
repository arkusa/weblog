(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{385:function(s,t,n){"use strict";n.r(t);var a=n(42),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"processing-model"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#processing-model"}},[s._v("#")]),s._v(" Processing Model")]),s._v(" "),n("p",[s._v("我们知道"),n("code",[s._v("javascript")]),s._v("是单线程, 但是在实际应用中无法避免的要使用到异步操作")]),s._v(" "),n("p",[s._v("e.g: "),n("code",[s._v("xhr请求")]),s._v(", "),n("code",[s._v("click event")]),s._v(", "),n("code",[s._v("timout")]),s._v("...")]),s._v(" "),n("p",[s._v("既然"),n("code",[s._v("javascript")]),s._v("存在一些异步API, 那么"),n("strong",[s._v("js引擎")]),s._v("如何调度同步脚本和异步脚本就成为了一个很重要的问题")]),s._v(" "),n("p",[n("strong",[s._v("js引擎")]),s._v("对同步/异步脚本的调度过程就是本章要讲述的"),n("code",[s._v("Processing Model")]),s._v(", 也就是常说的"),n("code",[s._v("Event Loop")])]),s._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[s._v("- 注意")]),s._v(" "),n("p",[s._v("本篇如果没有特意提及都是指 浏览器引擎的"),n("code",[s._v("Event Loop")])]),s._v(" "),n("p",[s._v("对于Node环境下的"),n("code",[s._v("Event Loop")]),s._v(", 没有做过详细的学习, 目前暂不提及")])]),s._v(" "),n("p",[s._v("看一下下面的🌰 (这是大学的时候面试今日头条的一个面试题, 也是通过这个面试题才对"),n("code",[s._v("Event Loop")]),s._v("有了深入的学习)")]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 写出输出顺序")]),s._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'script start'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'async1 end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'async2 end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'setTimeout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("resolve")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Promise'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'script end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 这里直接给出答案")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// script start")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// async2 end")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Promise")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// script end")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// async1 end")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// promise1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// promise2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// setTimeout")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br")])]),n("p",[s._v("如果你能对上面的顺序给出合理的解释, 我相信你已经掌握"),n("code",[s._v("Event Loop")]),s._v("了, 但是我还是建议你看阅读一下")]),s._v(" "),n("ul",[n("li",[n("p",[n("RouterLink",{attrs:{to:"/browser/processing_model.html#ui-render"}},[s._v("UI Render")])],1)]),s._v(" "),n("li",[n("p",[n("RouterLink",{attrs:{to:"/browser/processing_model.html#settimeout-setinterval-requsetanimationframe差异"}},[s._v("setTimeout...")])],1)])]),s._v(" "),n("p",[s._v("可能你会得到一些额外的收获")]),s._v(" "),n("h2",{attrs:{id:"event-loop"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#event-loop"}},[s._v("#")]),s._v(" Event Loop")]),s._v(" "),n("h3",{attrs:{id:"什么是event-loop"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#什么是event-loop"}},[s._v("#")]),s._v(" 什么是Event Loop")]),s._v(" "),n("p",[s._v("前面提到了"),n("code",[s._v("Event Loop")]),s._v("就是"),n("strong",[s._v("js引擎")]),s._v("对同步/异步任务的调度算法")]),s._v(" "),n("p",[s._v("如果你的英文能力可以的话, 我推荐你阅读"),n("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model",target:"_blank",rel:"noopener noreferrer"}},[s._v("event-loop-process-model-standard"),n("OutboundLink")],1)]),s._v(" "),n("p",[s._v("或者你也可以看一下这篇文章"),n("a",{attrs:{href:"https://github.com/aooy/blog/issues/5",target:"_blank",rel:"noopener noreferrer"}},[s._v("从event loop规范探究javaScript异步及浏览器更新渲染时机"),n("OutboundLink")],1),s._v(", 这篇文章内有对上述标准的翻译")]),s._v(" "),n("p",[s._v("对于"),n("strong",[s._v("macrotask queue")]),s._v("和"),n("strong",[s._v("microtask queue")]),s._v("这里不做过多赘述")]),s._v(" "),n("hr"),s._v(" "),n("p",[s._v("这里介绍几个H5标准提到的一些名词")]),s._v(" "),n("ul",[n("li",[n("p",[n("strong",[s._v("Task")])]),s._v(" "),n("p",[n("strong",[s._v("macrotask queue")]),s._v("中最先入队的回调函数")]),s._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[s._v("- 注意")]),s._v(" "),n("p",[s._v("同步脚本也是一个"),n("strong",[s._v("Task")])])])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("Job")])]),s._v(" "),n("p",[n("strong",[s._v("microtask queue")]),s._v("中最先入队的回调函数")])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("Jobs")])]),s._v(" "),n("p",[n("strong",[s._v("microtask queue")]),s._v("中的所有回调函数")])])]),s._v(" "),n("h3",{attrs:{id:"event-loop-流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#event-loop-流程"}},[s._v("#")]),s._v(" Event Loop 流程")]),s._v(" "),n("p",[n("img",{attrs:{src:"/weblog/imgs/browser_event_loop/event_loop.png",alt:"event loop"}})]),s._v(" "),n("p",[s._v("意思是, 浏览器在每一次的"),n("code",[s._v("Loop")]),s._v("中")]),s._v(" "),n("ol",[n("li",[n("p",[n("strong",[s._v("Task")]),s._v("阶段: 先执行"),n("strong",[s._v("Task")]),s._v(", 如果"),n("strong",[s._v("Task")]),s._v("不存在的话就跳过"),n("strong",[s._v("Task")]),s._v("阶段")])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("Jobs")]),s._v("阶段: "),n("strong",[s._v("Task")]),s._v("阶段完成后, 进入"),n("strong",[s._v("Jobs")]),s._v("阶段, 这个时候会执行所有存在的"),n("strong",[s._v("Job")]),s._v(", 没有则跳过")]),s._v(" "),n("p",[s._v("在"),n("strong",[s._v("Jobs")]),s._v("阶段还可能会产生新的"),n("strong",[s._v("Job")])]),s._v(" "),n("p",[s._v("e.g.")]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("Promise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'job 0'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'job 1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// job 1 就是在本次jobs阶段中产生的job")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("新的"),n("strong",[s._v("job")]),s._v("也会在当前"),n("strong",[s._v("Jobs")]),s._v("阶段执行, "),n("strong",[s._v("Jobs")]),s._v("阶段就是要清空所有的"),n("strong",[s._v("microtask queue")])])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("IndexDB")]),s._v("阶段: 清理所有的"),n("strong",[s._v("IndexDB")]),s._v("事务")])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("UI Render")]),s._v("阶段: "),n("code",[s._v("javascript引擎")]),s._v("被挂起, "),n("code",[s._v("GUI引擎")]),s._v("唤醒, CPU开始根据"),n("code",[s._v("RenderLayoutObject")]),s._v("制作纹理传入"),n("code",[s._v("GPU")])])]),s._v(" "),n("li",[n("p",[s._v("等待下一个"),n("strong",[s._v("Task")]),s._v("的响应，进行下一次的"),n("code",[s._v("Loop")])])])]),s._v(" "),n("hr"),s._v(" "),n("h3",{attrs:{id:"task和job事件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#task和job事件"}},[s._v("#")]),s._v(" Task和Job事件")]),s._v(" "),n("h4",{attrs:{id:"task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#task"}},[s._v("#")]),s._v(" Task")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("setTimeout")])]),s._v(" "),n("li",[n("code",[s._v("setInterval")])]),s._v(" "),n("li",[n("code",[s._v("requestAnimationFrame")])]),s._v(" "),n("li",[n("code",[s._v("xhr")])]),s._v(" "),n("li",[n("code",[s._v("DOM Event")])]),s._v(" "),n("li",[n("code",[s._v("MessageChannel")])])]),s._v(" "),n("h4",{attrs:{id:"job"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#job"}},[s._v("#")]),s._v(" Job")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("Promise.then")])]),s._v(" "),n("li",[n("code",[s._v("MutationObserver")])])]),s._v(" "),n("p",[s._v("值得注意的是浏览器并不是只存在一个"),n("strong",[s._v("macrotask queue")]),s._v("和一个"),n("strong",[s._v("microtask queue")]),s._v("然后将回调函数推入队列中")]),s._v(" "),n("p",[s._v("而是对于不同类型的回调函数, 推入相应类型的队列中, 在"),n("code",[s._v("Event Loop")]),s._v("调度的时候从几个队列中选择"),n("code",[s._v("Task")]),s._v("和"),n("code",[s._v("Job")])]),s._v(" "),n("p",[s._v("即:")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("macrotask queue:\n  timer queue(setTimeout):\n  xhr queue(xhr):\n  DOM Event:\n\nmicrotask queue:\n  Promise:\n  MutationObserver:\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h3",{attrs:{id:"event-loop的开始"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#event-loop的开始"}},[s._v("#")]),s._v(" Event Loop的开始")]),s._v(" "),n("p",[s._v("当脚本开始执行的时候"),n("code",[s._v("Event Loop")]),s._v("就已经开始工作了")]),s._v(" "),n("p",[s._v("一个错误的理解是: "),n("strong",[s._v("当同本脚本执行完毕后, 才开始"),n("code",[s._v("Event Loop")]),s._v("的调度")]),s._v(" ❌  ❌")]),s._v(" "),n("p",[s._v("🌰")]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'start'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'timeout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" ts "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Date")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getTime")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" te "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Date")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getTime")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("te "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ts "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  te "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Date")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getTime")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nPromise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'job 0'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'job 1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 按照错误的理解, 当同步脚本执行完毕后，进入Event Loop调度")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 此时应该优先执行Task, 即: timeout")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 所以期望的输出应该是")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// start")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// timeout")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// job 0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// job 1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 但是实际却并不是如此")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// start")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// job 0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// job 1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// timeout")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br")])]),n("p",[n("strong",[s._v("这也就是前面提到的, 同步脚本是一个Task")])]),s._v(" "),n("h3",{attrs:{id:"实践"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实践"}},[s._v("#")]),s._v(" 实践")]),s._v(" "),n("p",[s._v("采用最前面提到的🌰")]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'script start'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'async1 end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'async2 end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'setTimeout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("resolve")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Promise'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'script end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 同步脚本的执行就已经开始Event Loop")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ---------------- Task 阶段 ------------------------")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1. console.log(script start)")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2. async1();")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//    2.1. await async2();")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//      2.1.1. async2(); console.log(async2 end);")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//      2.1.2. async2()返回了一个resolve状态的promise")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//    2.2. Promise queue 被推入了一个job(job 0 -> console.log(async1 end))")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3. setTimeout(); 调起浏览器timer线程, 在0s后将console.log(setTimeout) 推入 Timeout queue (这里不考虑纳入标准的4ms, 因为经过我测试发现setTimeout(callback, 0)并不总是4ms, 还可能是1m..., 同时0s也更能说明问题)")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4. new Promise(); -> console.log(Promise);")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//    4.1 将console.log('promise1')作为job推入Promise queue(job 1 -> console.log('promise1'))")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 5. console.log('script end')")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 函数的伪调用栈为")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// callback stack(实际的调用栈不是这样的, 这里只是为了更好的说明问题，需要注意, 这里更像是callback queue):")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//    console.log(script start); // 1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//    console.log(async2 end);   // 2.1.1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//    console.log(Promise);      // 4")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//    console.log(script end);   // 5")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// macrotask queue:")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//      timeout queue:")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//          console.log(setTimeout); // 3")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// microtask queue")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//      promise queue:")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//          job0 -> console.log(async1 end)  // 2.2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//          job1 -> console.log(promise1)    // 4.1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 执行callback stack")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// script start")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// async2 end")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Promise")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// script end")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ------------Task 阶段结束, 进入Jobs阶段-----------------")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 将microtask queue 按照依次出队，压入callback stack")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// callback stack")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//    job0 -> console.log(async1 end)  // 2.2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//    job1 -> console.log(promise1)    // 4.1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// macrotask queue:")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//      timeout queue:")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//          console.log(setTimeout); // 3")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// microtask queue")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//      promise queue:")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 执行callback stack")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// async1 end")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// promise1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 但是需要注意的是 在执行job1结束后, promise queue 又入队了新的job(job 2 -> console.log(promise2))")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// microtask queue")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//      promise queue:")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//          job 2 -> console.log(promise2)")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 推入callback stack 执行后得到")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// microtask queue")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//      promise queue:")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Jobs阶段结束")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// -------------- IndexDB 事务 ---------------------")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// -------------- UI Render 阶段 -------------------")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 此时macrotask Queue还存在一个Task")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// macrotask queue:")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//      timeout queue:")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//          console.log(setTimeout); // 3")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 进入下一次 Loop 的 Task阶段")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 所以能得到")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// script start")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// async2 end")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Promise")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// script end")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// async1 end")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// promise1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// promise2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// setTimeout")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 这样的输出结果")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br"),n("span",{staticClass:"line-number"},[s._v("108")]),n("br"),n("span",{staticClass:"line-number"},[s._v("109")]),n("br"),n("span",{staticClass:"line-number"},[s._v("110")]),n("br"),n("span",{staticClass:"line-number"},[s._v("111")]),n("br"),n("span",{staticClass:"line-number"},[s._v("112")]),n("br"),n("span",{staticClass:"line-number"},[s._v("113")]),n("br"),n("span",{staticClass:"line-number"},[s._v("114")]),n("br"),n("span",{staticClass:"line-number"},[s._v("115")]),n("br")])]),n("h2",{attrs:{id:"ui-render"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ui-render"}},[s._v("#")]),s._v(" UI Render")]),s._v(" "),n("p",[n("code",[s._v("UI Render")]),s._v("阶段, "),n("strong",[s._v("GUI引擎")]),s._v("开始工作, "),n("strong",[s._v("javascript引擎")]),s._v("被挂起, "),n("strong",[s._v("CPU")]),s._v("开始绘制纹理输入"),n("strong",[s._v("GPU")])]),s._v(" "),n("p",[n("code",[s._v("UI Render")]),s._v("是浏览器实现"),n("code",[s._v("batch render")]),s._v("的核心逻辑")]),s._v(" "),n("p",[s._v("看一下🌰")]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("div"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'200px'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ndiv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'300px'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 这样的代码浏览器只会制作一个纹理, 而不是制作2个纹理")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 可以这样理解")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// GUI引擎维护了一个队列")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 在执行div.style.top = '200px'; 时 ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// javascript 引擎 通知 GUI引擎 入队一个div.style.top = 200的回调函数")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 同理, 这个队列中维护了2个回调")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// gui queue:")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//    div.style.top = 200")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//    div.style.top = 300")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 在UI Render阶段清空队列任务, 绘制纹理")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h3",{attrs:{id:"transition动画"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#transition动画"}},[s._v("#")]),s._v(" Transition动画")]),s._v(" "),n("p",[n("strong",[s._v("UI Render")]),s._v(" 一个具体的应用就是"),n("code",[s._v("transition")]),s._v("动画")]),s._v(" "),n("p",[s._v("🌰")]),s._v(" "),n("div",{staticClass:"language-html line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("div")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("id")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("div"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("style")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),n("span",{pre:!0,attrs:{class:"token style"}},[n("span",{pre:!0,attrs:{class:"token language-css"}},[s._v("\n    "),n("span",{pre:!0,attrs:{class:"token selector"}},[s._v("#div")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v("position")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" absolute"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v("width")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 100px"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v("height")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 100px"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v("background-color")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" red"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  ")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("style")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 想让这个div在文档加载完成后右200px的位置滚动到300px的位置 --\x3e")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 我们需要添加一些javascript代码 --\x3e")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" div "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" document"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getElementById")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'div'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// example 1")]),s._v("\ndiv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'200px'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ndiv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("transition "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'top linear 1s'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ndiv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'300px'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果你有经验的话，你知道它一定是不行的")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 你可能会这样")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// example 2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  div"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'300px'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 不知道你没有想过为什么要么做")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("其实这也和"),n("code",[s._v("Event Loop")]),s._v("有关")]),s._v(" "),n("p",[s._v("我们知道过渡动画需要"),n("strong",[s._v("start")]),s._v("和"),n("strong",[s._v("end")]),s._v("2种状态, 这就意味着"),n("strong",[s._v("GUI")]),s._v("需要相应的制作2个纹理")]),s._v(" "),n("p",[s._v("而在上面的例子中")]),s._v(" "),n("ul",[n("li",[n("p",[n("code",[s._v("example 1")])]),s._v(" "),n("p",[s._v("由于发生了一次"),n("code",[s._v("Event Loop")]),s._v(", 所以有1个"),n("code",[s._v("UI Render")]),s._v(", 生成了1个纹理, 所以没有产生过渡")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("example 2")])]),s._v(" "),n("p",[s._v("发生了2次"),n("code",[s._v("Event Loop")]),s._v(", 有2个"),n("code",[s._v("UI Render")]),s._v(", 并且2次的"),n("code",[s._v("UI Render")]),s._v("队列都不是空的, 所以产生了2个纹理, 对应了2个"),n("code",[s._v("top")]),s._v("状态, 所以过渡动画生效")])])]),s._v(" "),n("p",[s._v("你也可以这样")]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" port1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" port "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageChannel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nport1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("onmessage")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  div"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'300px'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nport2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("postMessage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("但是这样则不可以")]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("Promise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" div"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'300px'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 因为这是一个job 而不是一个新的task")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"gui引擎的唤醒"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gui引擎的唤醒"}},[s._v("#")]),s._v(" GUI引擎的唤醒")]),s._v(" "),n("p",[s._v("GUI引擎的唤醒有2种方式")]),s._v(" "),n("ul",[n("li",[n("p",[n("code",[s._v("UI Render")])]),s._v(" "),n("p",[s._v("前面提到过, "),n("code",[s._v("UI Render")]),s._v("阶段会挂起"),n("code",[s._v("javascript 引擎")]),s._v(", 唤醒"),n("code",[s._v("GUI引擎")])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("回流")])]),s._v(" "),n("p",[s._v("前面提到过, 浏览器具有"),n("code",[s._v("batch render")]),s._v("功能, 统一在"),n("code",[s._v("UI Render")]),s._v("阶段制作纹理")]),s._v(" "),n("p",[s._v("但是在某些需要读取元素位置的回流操作上, 可以打破上述规则, 在非"),n("code",[s._v("UI Render")]),s._v("的阶段唤醒"),n("code",[s._v("GUI 引擎")]),s._v("制作纹理")]),s._v(" "),n("p",[s._v("像前面提到的"),n("code",[s._v("transition")]),s._v("的 🌰 , 为了实现过渡效果我们还可以这样")]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("div"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'200px'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ndiv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("transition "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'top linear 1s'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ndocument"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("body"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getBoundingClientRect")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 唤醒GUI引擎, 根据维护的队列内容绘制纹理(top = 200)")]),s._v("\n\ndiv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'300px'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 在本次 Event Loop 的 UI Render阶段 绘制纹理(top = 300)")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 这也是可行的")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])])])]),s._v(" "),n("h2",{attrs:{id:"settimeout-setinterval-requsetanimationframe差异"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#settimeout-setinterval-requsetanimationframe差异"}},[s._v("#")]),s._v(" setTimeout, setInterval, requsetAnimationFrame差异")]),s._v(" "),n("h3",{attrs:{id:"浏览器是如何渲染元素的"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#浏览器是如何渲染元素的"}},[s._v("#")]),s._v(" 浏览器是如何渲染元素的")]),s._v(" "),n("p",[n("a",{attrs:{href:""}},[s._v("TODO 这里是一个单独的内容")])]),s._v(" "),n("p",[s._v("简单来说就是")]),s._v(" "),n("ol",[n("li",[n("code",[s._v("GUI 引擎")]),s._v("不定时根据"),n("code",[s._v("javascript 引擎")]),s._v("维护的"),n("code",[s._v("RenderLayoutObject")]),s._v("绘制纹理")])]),s._v(" "),n("ul",[n("li",[s._v("这里就涉及到"),n("strong",[s._v("GUI 引擎的唤醒")]),s._v("( "),n("code",[s._v("UI Render")]),s._v(", "),n("code",[s._v("回流")]),s._v(")")])]),s._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[n("p",[s._v("将绘制出的纹理传入"),n("strong",[s._v("GPU")])])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("GPU")]),s._v("不定时将纹理"),n("strong",[s._v("paint")]),s._v("到页面上(这个时间就是 1 / 浏览器刷新频率)")])])]),s._v(" "),n("p",[s._v("对于某些开始了"),n("strong",[s._v("GPU 加速")]),s._v("的"),n("strong",[s._v("layer")]),s._v(", 则跳过了"),n("strong",[s._v("CPU绘制纹理的过程")])]),s._v(" "),n("h3",{attrs:{id:"跳帧"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#跳帧"}},[s._v("#")]),s._v(" 跳帧")]),s._v(" "),n("p",[s._v("跳帧是一种逻辑上的正确, 但是在UI表现上是错误的")]),s._v(" "),n("p",[s._v("🌰")]),s._v(" "),n("p",[s._v("一个人以"),n("strong",[s._v("1m/s")]),s._v(" 的 速度跑了10s")]),s._v(" "),n("p",[s._v("你以"),n("strong",[s._v("1hz")]),s._v("的频率眨眼")]),s._v(" "),n("p",[s._v("所以你能看到的这个人的位移过程是")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("1m -> 2m -> 3m -> 4m -> ... 10m\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("但是如果某次你突然迷眼了, 你可能用了5s来清理👀 , 等你再次看这个人的时候他可能已经跑完了")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("1m -> 2m -> 3m -> 4m -> 5m -> 10m\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[n("code",[s._v("5m -> 10m")]),s._v("的过程就是跳帧")]),s._v(" "),n("h3",{attrs:{id:"卡顿"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#卡顿"}},[s._v("#")]),s._v(" 卡顿")]),s._v(" "),n("p",[s._v("卡顿和跳帧相反, 是逻辑上的错误, UI正确")]),s._v(" "),n("p",[s._v("还是这个人在🏃‍")]),s._v(" "),n("p",[s._v("不过其速度是 0.00001m/s")]),s._v(" "),n("p",[s._v("这看起来好像是个没开发完的机器人🤖️")]),s._v(" "),n("p",[s._v("这还算是跑步么?")]),s._v(" "),n("p",[s._v("卡顿一般都是由于 渲染动画的时间设置不正确")]),s._v(" "),n("h3",{attrs:{id:"setinterval"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#setinterval"}},[s._v("#")]),s._v(" setInterval")]),s._v(" "),n("p",[s._v("用"),n("code",[s._v("setInterval")]),s._v("实现动画最大的弊病在于其很可能会出现跳帧的情况")]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" offset "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setInterval")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  offset "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  div"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" offset "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'px'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("这段代码期望CPU 每1000 / 60 ms 绘制一个纹理, 传给GPU")]),s._v(" "),n("p",[s._v("但是实际并不总是如此, 根据前面"),n("code",[s._v("Event Loop")]),s._v("的内容, 假如前一个"),n("strong",[s._v("Task")]),s._v("发生了5 * 1000 / 60ms的阻塞")]),s._v(" "),n("p",[s._v("那么当前"),n("strong",[s._v("macrotask queue")]),s._v("应该是这样的")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("macrotask queue:\n    interval queue: \n        task 0 -> offset += 10;\n        task 1 -> offset += 10;\n        task 2 -> offset += 10;\n        task 3 -> offset += 10;\n        task 4 -> offset += 10;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("这个时候对于"),n("code",[s._v("task 0, task 1, task 2, task 3, task 4")]),s._v("这些"),n("strong",[s._v("Task")]),s._v("而言就失去了"),n("code",[s._v("1000 / 60")]),s._v("的时间间隔")]),s._v(" "),n("p",[n("strong",[s._v("GPU")]),s._v("直接在下次"),n("strong",[s._v("paint")]),s._v("的时候将最终结果"),n("code",[s._v("offset = 60")]),s._v(" 绘制 到 页面上")]),s._v(" "),n("p",[s._v("即:")]),s._v(" "),n("p",[n("code",[s._v("setInterval")]),s._v("会发生跳帧")]),s._v(" "),n("h3",{attrs:{id:"settimeout"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#settimeout"}},[s._v("#")]),s._v(" setTimeout")]),s._v(" "),n("p",[s._v("使用"),n("code",[s._v("setTimeout")]),s._v("就不会出现跳帧的现象, 因为"),n("code",[s._v("setTimeout")]),s._v("实现的动画是在最后产生了下一个"),n("strong",[s._v("Task")]),s._v(", 即使前一个"),n("strong",[s._v("Loop")]),s._v("发生阻塞, "),n("strong",[s._v("macrotask queue")]),s._v("也不会像"),n("code",[s._v("setInterval")]),s._v("一样堆积了很多的"),n("strong",[s._v("Animation Task")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" offest "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("animation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  offset "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  div"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" offset "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'px'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("animation"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("animation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("hr"),s._v(" "),n("p",[s._v("看来多么的美好 !!!")]),s._v(" "),n("p",[s._v("但是"),n("code",[s._v("setTimout")]),s._v("设置的时间要足够合适")]),s._v(" "),n("p",[s._v("太大或者太小都会有其他问题")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("时间间隔很小, 可能会有性能问题")]),s._v(" "),n("p",[s._v("浏览器"),n("strong",[s._v("GPU")]),s._v("绘制1次, "),n("strong",[s._v("CPU")]),s._v("绘制了多个纹理, 我们知道"),n("code",[s._v("GUI")]),s._v("和"),n("code",[s._v("JS")]),s._v("是互斥的")]),s._v(" "),n("p",[n("strong",[s._v("GPU")]),s._v("只使用到了最后一个纹理, 其他都被浪费, "),n("code",[s._v("javascript 引擎")]),s._v("被无意义的挂起")])]),s._v(" "),n("li",[n("p",[s._v("时间间隔很大, 可能会卡顿")])])]),s._v(" "),n("hr"),s._v(" "),n("p",[s._v("所以这个时间间隔尽量和"),n("strong",[s._v("GPU")]),s._v("每次绘制的时间间隔一致(浏览器刷新频率)")]),s._v(" "),n("p",[s._v("一般浏览器刷新是"),n("code",[s._v("60HZ")]),s._v("(平均)")]),s._v(" "),n("p",[s._v("这也是我们总设置"),n("code",[s._v("1000 / 60")]),s._v("的原因")]),s._v(" "),n("p",[s._v("但是毕竟浏览器的刷新频率是一个动态的值, 所以后面"),n("code",[s._v("H5")]),s._v("提出了"),n("code",[s._v("requestAnimationFrame")]),s._v("这个API")]),s._v(" "),n("h3",{attrs:{id:"requestanimationframe"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#requestanimationframe"}},[s._v("#")]),s._v(" requestAnimationFrame")]),s._v(" "),n("p",[n("code",[s._v("requestAnimationFrame")]),s._v("期望回调函数在浏览器刷新"),n("code",[s._v("frame")]),s._v("前执行")]),s._v(" "),n("p",[s._v("用它实现"),n("code",[s._v("js")]),s._v("动画就是一个动态设置时间的"),n("code",[s._v("setTimeout")]),s._v(", 并且这个时间总是最合适的")]),s._v(" "),n("p",[s._v("这就保证了, 在"),n("strong",[s._v("GPU")]),s._v("绘制前, "),n("strong",[s._v("CPU")]),s._v("总是输入给"),n("strong",[s._v("GPU")]),s._v("一个纹理")]),s._v(" "),n("p",[s._v("世界美好了 ！！")]),s._v(" "),n("h2",{attrs:{id:"node-event-loop"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#node-event-loop"}},[s._v("#")]),s._v(" Node Event Loop")]),s._v(" "),n("p",[s._v("node event loop 是基于 "),n("code",[s._v("libuv")]),s._v("实现的, 挺乱的, 暂时没有整理")]),s._v(" "),n("p",[s._v("TODO 这里应该是一个链接")])])}),[],!1,null,null,null);t.default=e.exports}}]);